<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>AVIS</title>
</head>
<body>
    <h1>AVIS - 아희 시각화</h1>
    <div>
        <button id="mode-edit">편집모드</button>
        <button id="mode-exec">실행모드</button>
        <div id="editor">
            <textarea cols="50" rows="20"></textarea>
        </div>
        <div id="visualizer">
            <button>초기화</button>
            <button>실행</button>
            <button>멈춤</button>
            <button>한 단계만</button>
            <div id="code-area"></div>
        </div>
    </div>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script type="text/javascript" src="naheui/aheui.js"></script>
    <script type="text/javascript">
        var codeSpace = [];
        var Machine = new Aheui.Machine(codeSpace);
        $('#mode-edit').click(function () {
            $('#mode-edit').attr('disabled', true);
            $('#mode-exec').removeAttr('disabled');
            $('#editor').show();
            $('#visualizer').hide();
        });
        $('#mode-exec').click(function () {
            $('#mode-exec').attr('disabled', true);
            $('#mode-edit').removeAttr('disabled');
            $('#editor').hide();
            $('#visualizer').show();
            var source = $('#editor textarea').val();
            codeSpace = Aheui.codeSpace(source);
            codeSpace.width = (function () {
                var width = 0;
                codeSpace.forEach(function (line) {
                    if (width < line.length)
                        width = line.length;
                });
                return width;
            })();
            codeSpace.height = codeSpace.length;
            Machine = new Aheui.Machine(codeSpace);
            render();
        });
        $(function () { // init
            $('#mode-edit').click();
        });
        function render() {
            $('#code-area').html(codeSpace.map(function (line) {
                return [
                    '<div class="line">',
                    line.map(function (code) {
                        return [
                            '<div class="cell">', code.char, '</div>'
                        ].join('');
                    }).join(''),
                    '</div>'
                ].join('');
            }).join(''));
            $('#code-area .cell').mouseover(function () {
                var $this = $(this);
                var x = $this.index();
                var y = $this.parent().index();
                clearColor();
                renderFuture(x, y);
            });
        }
        function clearColor() {
            $('#code-area .cell').css('background-color', 'transparent');
        }
        function renderFuture(x, y) {
            console.log(codeSpace);
            var future = seekNext(x, y, 0, 0);
            console.log(future);
            future.forEach(function (next) {
                var line = $('#code-area .line').eq(next.y);
                var cell = $('.cell', line).eq(next.x);
                cell.css('background-color', '#f00');
            });
        }
        function getVector(code) {
            var index = Aheui.jung(code);
            return {
                x: Aheui.xSpeedTable[index],
                y: Aheui.ySpeedTable[index],
            };
        }
        function seekNext(x, y, dx, dy) {
            var result = [];
            var width = codeSpace.width;
            var height = codeSpace.height;
            var code = codeSpace[y][x];
            if (!code)
                return result;
            var vector = getVector(code);
            if (vector.x === undefined)
                vector.x = dx;
            else if (vector.x === 'reflect')
                vector.x = -dx;
            if (vector.y === undefined)
                vector.y = dy;
            else if (vector.y === 'reflect')
                vector.y = -dy;
            if (vector.x === 0 && vector.y === 0)
                return result;
            function seek(x, y, dx, dy) {
                var wrap = false;
                while (true) {
                    if (x >= width)
                        x = 0;
                    else if (x < 0)
                        x = width - 1;
                    if (y >= height)
                        y = 0;
                    else if (y < 0)
                        y = height - 1;
                    var line = codeSpace[y];
                    if (!line)
                        return;
                    var code = line[x];
                    if (code && code.jung !== -1) {
                        result.push({x: x, y: y, dx: dx, dy: dy});
                        return;
                    }
                    x += dx;
                    y += dy;
                    if (x >= width || x < 0 || y >= height || y < 0) {
                        if (wrap)
                            return;
                        else
                            wrap = true;
                    }
                }
            }
            switch (code.cho) {
            case 2: case 3: case 4: case 5: case 6:
            case 8: case 10: case 12: case 14: case 16:
            case 17:
                seek(x + vector.x, y + vector.y, vector.x, vector.y);
                seek(x - vector.x, y - vector.y, -vector.x, -vector.y);
                break;
            case 18:
                break;
            default:
                seek(x + vector.x, y + vector.y, vector.x, vector.y);
                break;
            }
            return result;
        }
    </script>
    <style type="text/css">
        @import url('http://fonts.googleapis.com/earlyaccess/nanumgothic.css');
        #code-area {
            display: table;
            font-size: 10px;
            font-family: 'Nanum Gothic';
            border-collapse: collapse;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            cursor: default;
        }
        #code-area .line {
            display: table-row;
        }
        #code-area .line .cell {
            display: table-cell;
            width: 15px;
            height: 15px;
            text-align: center;
            line-height: 15px;
            border: 1px solid #ddd;
        }
    </style>
</body>
</html>
